<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <title>Heatmap de Vendas - HERE Maps</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- HERE Maps v3.1 -->
  <script src="https://js.api.here.com/v3/3.1/mapsjs-core.js"></script>
  <script src="https://js.api.here.com/v3/3.1/mapsjs-service.js"></script>
  <script src="https://js.api.here.com/v3/3.1/mapsjs-ui.js"></script>
  <script src="https://js.api.here.com/v3/3.1/mapsjs-mapevents.js"></script>
  <script src="https://js.api.here.com/v3/3.1/mapsjs-data.js"></script>
  <script src="https://js.api.here.com/v3/3.1/mapsjs-heatmap.js"></script>
  <link rel="stylesheet" href="https://js.api.here.com/v3/3.1/mapsjs-ui.css" />

  <style>
    html, body { height:100%; margin:0; }
    #map { width:100%; height:100vh; }
    .warn {
      position: fixed; top: 12px; left: 12px;
      background: #fff3cd; color:#664d03; border:1px solid #ffe69c;
      padding:8px 12px; border-radius:6px; font: 14px/1.3 system-ui; z-index: 9999;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <script>
    // --------- 1) Input via URL (?apikey=...&data=... ) ----------
    const qs = new URLSearchParams(window.location.search);
    const apikey = qs.get("apikey") || "COLOCA_AQUI_A_TUA_CHAVE_SE_NÃO_PASSARES_NO_URL";
    let sales = [];
    try {
      const raw = qs.get("data");
      if (raw) sales = JSON.parse(decodeURIComponent(raw));
    } catch (e) {
      console.error("Erro a ler ?data:", e);
    }

    if (!Array.isArray(sales) || sales.length === 0) {
      const warn = document.createElement("div");
      warn.className = "warn";
      warn.textContent = "Sem dados (?data vazio).";
      document.body.appendChild(warn);
    }

    // --------- 2) Plataforma + mapa base (ruas/labels) ----------
    const platform = new H.service.Platform({ apikey });
    const defaultLayers = platform.createDefaultLayers();

    const map = new H.Map(
      document.getElementById("map"),
      // vector normal (ruas, labels visíveis por baixo do heatmap)
      defaultLayers.vector.normal.map,
      { zoom: 7, center: { lat: 39.7, lng: -8.0 }, pixelRatio: window.devicePixelRatio || 1 }
    );

    // Interação + UI
    const behavior = new H.mapevents.Behavior(new H.mapevents.MapEvents(map));
    const ui = H.ui.UI.createDefault(map, defaultLayers);

    // Resize responsivo
    window.addEventListener("resize", () => map.getViewPort().resize());

    // --------- 3) Preparar pontos do heatmap ----------
    const points = [];
    const values = [];

    for (const d of (sales || [])) {
      const lat = Number(d.lat), lng = Number(d.lng), val = Number(d.total_vendas);
      // Filtro geográfico para apenas território continental português
      if (
        Number.isFinite(lat) && Number.isFinite(lng) && Number.isFinite(val) &&
        lng > -10 && lng < -6.0 && lat > 36 && lat < 43
      ) {
        points.push({ lat, lng, value: val });
        values.push(val);
      }
    }

    values.sort((a, b) => a - b);
    const vmax = values.length ? values[Math.floor(values.length * 0.95)] : 1;
    const vmin = 0;

    // Clampa valores ao percentil 95 (para evitar saturação)
    for (const p of points) {
      p.value = Math.min(p.value, vmax);
    }

    // --------- 4) Criar Heatmap Provider ----------
    const heatmapProvider = new H.data.heatmap.Provider({
      type: "value", // usa p.value para intensidade
      radii: [
        { zoom: 5, value: 8 },
        { zoom: 6, value: 10 },
        { zoom: 7, value: 14 },
        { zoom: 8, value: 18 },
        { zoom: 9, value: 22 },
        { zoom: 10, value: 26 },
        { zoom: 11, value: 30 }
      ],
      opacity: 0.65,
      colors: new H.data.heatmap.Colors({
        0.00: "rgba(0, 0, 255, 0.00)",
        0.20: "rgba(0, 128, 255, 0.60)",
        0.40: "rgba(0, 255, 0, 0.70)",
        0.65: "rgba(255, 255, 0, 0.80)",
        0.85: "rgba(255, 128, 0, 0.90)",
        1.00: "rgba(255, 0, 0, 0.95)"
      })
    });

    heatmapProvider.addData(points);

    // --------- 5) Adicionar layer ao mapa ----------
    const heatmapLayer = new H.map.layer.TileLayer(heatmapProvider);
    map.addLayer(heatmapLayer);

    // --------- 6) Fit automático aos pontos e zoom ajustado ----------
    if (points.length) {
      const rect = points.reduce((b, p) => {
        if (!b) return new H.geo.Rect(p.lat, p.lng, p.lat, p.lng);
        b.mergePoint(p.lat, p.lng);
        return b;
      }, null);

      if (rect) {
        // Fit inicial aos pontos
        map.getViewModel().setLookAtData({ bounds: rect });
        // Zoom ligeiramente mais aproximado
        setTimeout(() => {
          const vm = map.getViewModel();
          vm.setLookAtData({
            position: vm.getLookAtData().position,
            zoom: vm.getLookAtData().zoom + 0.8
          });
        }, 500);
      }
    }
  </script>
</body>
</html>