<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <title>Heatmap de Vendas - Portugal</title>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <style>
    html, body {
      margin: 0;
      height: 100%;
      background: #ffffff;
      font-family: system-ui, sans-serif;
    }
    #chart {
      width: 100%;
      height: 100vh;
    }
  </style>
</head>
<body>
  <div id="chart"></div>
  <script>
    // =============================
    // 1️⃣ Ler dados do parâmetro ?data=
    // =============================
    const params = new URLSearchParams(window.location.search);
    const dataParam = params.get("data");
    let sales = [];
    try {
      if (dataParam) sales = JSON.parse(decodeURIComponent(dataParam));
    } catch (e) {
      console.error("Erro ao ler ?data:", e);
    }

    console.log("Dados recebidos:", sales);

    // Mensagem visual se vier sem dados
    if (!Array.isArray(sales) || sales.length === 0) {
      const warn = document.createElement("div");
      warn.style.cssText = `
        position:fixed;top:8px;left:8px;
        background:#fff3cd;color:#664d03;
        padding:8px 12px;border:1px solid #ffe69c;
        border-radius:6px;font:14px/1.3 system-ui;
        z-index:9999;
      `;
      warn.textContent = "Sem dados (?data vazio). Adiciona ?data=[...] ao URL ou verifica o iframe.";
      document.body.appendChild(warn);
    }

    // =============================
    // 2️⃣ Preparar dados para o ECharts
    // =============================
    const points = (sales || []).map(d => [
      Number(d.lng),
      Number(d.lat),
      Number(d.total_vendas)
    ]);

    const values = points.map(p => p[2]).filter(v => Number.isFinite(v));
    const vmin = values.length ? Math.min(...values) : 0;
    const vmax = values.length ? Math.max(...values) : 1;

    const chart = echarts.init(document.getElementById("chart"));

    // =============================
    // 3️⃣ Carregar GeoJSON real de Portugal
    // =============================
    fetch("https://raw.githubusercontent.com/deldersveld/topojson/master/countries/portugal/portugal-districts.json")
      .then(res => res.json())
      .then(geoJson => {
        echarts.registerMap("portugal", geoJson);

        const option = {
          backgroundColor: "#ffffff",
          title: {
            text: "Heatmap de Vendas - Portugal",
            left: "center",
            textStyle: { fontSize: 18 }
          },
          tooltip: {
            position: "top",
            formatter: p => {
              if (!p || !p.value) return "";
              return `
                <b>Vendas</b><br>
                Latitude: ${(+p.value[1]).toFixed(4)}<br>
                Longitude: ${(+p.value[0]).toFixed(4)}<br>
                Valor: ${p.value[2]}
              `;
            }
          },
          visualMap: {
            min: vmin,
            max: Math.max(vmax, 1),
            calculable: true,
            orient: "horizontal",
            left: "center",
            bottom: 10,
            inRange: {
              color: ["#2b83ba", "#abdda4", "#ffffbf", "#fdae61", "#d7191c"]
            }
          },
          geo: {
            map: "portugal",
            roam: true,
            zoom: 1.2,
            center: [-8.1, 39.5],
            itemStyle: {
              areaColor: "#e9f2ff",
              borderColor: "#8aa3bf"
            },
            emphasis: {
              itemStyle: { areaColor: "#d7e8ff" }
            },
            label: { show: false }
          },
          series: [
            {
              name: "Vendas",
              type: "heatmap",
              coordinateSystem: "geo",
              data: points,
              blurSize: 25,
              pointSize: 12,
              opacity: 0.85
            }
          ]
        };

        chart.setOption(option);
        window.addEventListener("resize", () => chart.resize());
      })
      .catch(err => {
        console.error("Erro ao carregar GeoJSON:", err);
        const errDiv = document.createElement("div");
        errDiv.textContent = "Erro ao carregar o mapa de Portugal.";
        errDiv.style.cssText = `
          position:fixed;top:50%;left:50%;
          transform:translate(-50%,-50%);
          background:#ffebee;color:#b71c1c;
          padding:12px 20px;border-radius:8px;
          font:16px/1.4 system-ui;
        `;
        document.body.appendChild(errDiv);
      });
  </script>
</body>
</html>